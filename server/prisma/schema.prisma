// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  avatarUrl     String?   @map("avatar_url")
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  moments       Moment[]
  tags          Tag[]

  @@map("users")
}

model Moment {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  title        String
  description  String?
  momentDate   DateTime  @map("moment_date")
  emotion      String?   // happy, sad, exciting, nostalgic, neutral
  importance   Int?      @default(3) // 1-5 scale
  locationName String?   @map("location_name")
  locationLat  Decimal?  @map("location_lat") @db.Decimal(10, 8)
  locationLng  Decimal?  @map("location_lng") @db.Decimal(11, 8)
  isDraft      Boolean   @default(false) @map("is_draft")
  flagged      Boolean   @default(false)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mediaFiles   MediaFile[]
  tags         MomentTag[]
  relations    MomentRelation[] @relation("MomentRelations")
  relatedBy    MomentRelation[] @relation("RelatedMoments")

  @@index([userId, momentDate])
  @@index([emotion])
  @@map("moments")
}

model MediaFile {
  id               String   @id @default(uuid())
  momentId         String   @map("moment_id")
  fileType         String   @map("file_type") // image, video, document, audio
  originalFilename String   @map("original_filename")
  storageKey       String   @map("storage_key")
  thumbnailKey     String?  @map("thumbnail_key")
  mediumKey        String?  @map("medium_key")
  fileSize         Int      @map("file_size")
  mimeType         String   @map("mime_type")
  width            Int?
  height           Int?
  duration         Int?     // for videos/audio in seconds
  metadata         Json?
  orderIndex       Int      @default(0) @map("order_index")
  createdAt        DateTime @default(now()) @map("created_at")
  
  moment           Moment   @relation(fields: [momentId], references: [id], onDelete: Cascade)

  @@index([momentId])
  @@map("media_files")
}

model Tag {
  id        String      @id @default(uuid())
  userId    String      @map("user_id")
  name      String
  color     String?     // hex color
  createdAt DateTime    @default(now()) @map("created_at")
  
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  moments   MomentTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

model MomentTag {
  momentId String @map("moment_id")
  tagId    String @map("tag_id")
  
  moment   Moment @relation(fields: [momentId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([momentId, tagId])
  @@map("moment_tags")
}

model MomentRelation {
  momentId        String @map("moment_id")
  relatedMomentId String @map("related_moment_id")
  relationType    String @map("relation_type") // same_people, same_location, same_event
  
  moment          Moment @relation("MomentRelations", fields: [momentId], references: [id], onDelete: Cascade)
  relatedMoment   Moment @relation("RelatedMoments", fields: [relatedMomentId], references: [id], onDelete: Cascade)

  @@id([momentId, relatedMomentId])
  @@map("moment_relations")
}
